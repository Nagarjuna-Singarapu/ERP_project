{% extends "dash_navbar.html" %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Employee Form</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    {% block css %}
    <link rel="stylesheet" href="{% static 'hrms_css/emp_per/NewEmploye.css' %}">
    {% endblock %}
</head>

<body>
    <div class="container mt-5">
        <h2>New Employee</h2>
        <form method="POST" action="/hrms/submit-employee/">
            <!-- Employee Details -->
            {% csrf_token %}


            <div class="row">

                    <div class="col-md-4 mb-2">

                        <label for="title" class="form-label">Title</label>
                        <select id="title" name="title" required>
                            <option value="">Select a title</option>
                            <option value="Mr">Mr</option>
                            <option value="Ms">Ms</option>
                            <option value="Mrs">Mrs</option>
                            <option value="Dr">Dr</option>
                            <option value="Prof">Prof</option>
                        </select><br><br>
                        </span></label>
    
                </div>

                <div class="col-md-4 mb-2">
                    <label for="first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="firstName" placeholder="Enter first name" name="first_name" required>
                </div>
                <div class="col-md-4 mb-2">
                    <label for="middle_initial" class="form-label">Middle Initial</label>
                    <input type="text" class="form-control" id="middleInitial" name="middle_initial" placeholder="M.I.">
                </div>
                <div class="col-md-4 mb-2">
                    <label for="last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="lastName" name="last_name" placeholder="Enter last name" required>
                </div>

                <div class="col-md-4 mb-2">

                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender" required>
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select><br><br>
                    </span></label>

                </div>

            </div>
            <div class="mb-3">
                <label for="internal_organization" class="form-label">Internal Organization</label>
                <select class="form-select" id="internal_organization" name="internal_organization">
                    <option value="">Select a Organization</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="planned_start_date" class="form-label">Estimated Start Date</label>
                <input type="date" class="form-control" id="planned_start_date" name="planned_start_date">
            </div>

            <!-- Address Section -->
            <h5>Address</h5>
            <div class="mb-3">
                <label for="address1" class="form-label">Address 1 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="address1" name="address1" placeholder="Enter address line 1" required>
            </div>
            <div class="mb-3">
                <label for="address2" class="form-label">Address 2</label>
                <input type="text" class="form-control" id="address2" name="address2" placeholder="Enter address line 2">
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="country" class="form-label">Country</label>
                    <select class="form-select" id="country" name="country" required>
                        <option value="">Select a country</option>
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="state" class="form-label">State</label>
                    <select class="form-select" id="state" name="state" required>
                        <option value="">Select a state</option>
                    </select>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="city" class="form-label">City <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="city" name="city" placeholder="Enter city" required>
                </div>
                
               
                <div class="col-md-4 mb-3">
                    <label for="zip_code" class="form-label">Zip/Postal Code <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="zip_code" name="zip_code" placeholder="Enter zip code" required>
                </div>
            </div>
           

            <!-- Phone Number Section -->
            <h5>Primary Phone Number</h5>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="phone_code" class="form-label">Country Code</label>
                    <select class="form-select" id="phone_code" name="phone_code" required>
                        <option value="">Select a state</option>
                    </select>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="phone_number" class="form-label">Phone Number <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="phone_number" name="phone_number" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label for="ext" class="form-label">Ext</label>
                    <input type="text" class="form-control" id="ext">
                </div>
            </div>

            <!-- Email Section -->
            <div class="mb-3">
                <label for="email" class="form-label">E-Mail Address</label>
                <input type="email" class="form-control" id="email" name="email" placeholder="Enter email address" required>
            </div>

            <div class="mb-3">
                <label for="employee_id" class="form-label">Employee ID:</label>
                <input type="text" class="form-control" id="employee_id" name="employee_id" placeholder="Enter Employe Id" required>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md">
                <button class="btn btn-primary me-md-2 btn-sm" type="submit" role="button">save</button>
                {% comment %} <button class="btn btn-primary btn-sm" type="button">
                    <a class="btn btn-primary" href="{% url 'emp_main' %}" role="button">Find Employe</a></button> {% endcomment %}
            </div>
    </div>

    {% if errors %}
    <script>
        let errorMessage = "";

        `{% for field, message in errors.items %}`
            errorMessage += `{{ message|escapejs }}\n`;
        `{% endfor %}`

        if (errorMessage) {
            alert(errorMessage);
        }
    </script>
    {% endif %}

    {% if success %}
        <script>
            alert("Employee  has been successfully created...!");
        </script>
    {% endif %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        
        async function loadCountriesAndPhoneCodes() {
            const response = await fetch('/hrms/api/countries/');
            const countries = await response.json();

            const countrySelect = document.getElementById('country');
            const phoneCodeSelect = document.getElementById('phone_code');

            countries.forEach(country => {
                // Populate country dropdown
                const countryOption = document.createElement('option');
                countryOption.value = country.name;
                countryOption.textContent = country.name;
                countrySelect.appendChild(countryOption);

                // Populate phone code dropdown
                const phoneCodeOption = document.createElement('option');
                phoneCodeOption.value = country.phonecode;
                phoneCodeOption.textContent = `+${country.phonecode}`;
                phoneCodeSelect.appendChild(phoneCodeOption);
            });
        }

        // Load states based on selected country
        document.getElementById('country').addEventListener('change', async function () {
            const countryName = this.value;

            const response = await fetch(`/hrms/api/states/${countryName}/`);
            const states = await response.json();

            const stateSelect = document.getElementById('state');
            stateSelect.innerHTML = '<option value="">Select a state</option>';

            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
        });

        // Load countries and phone codes on page load
        document.addEventListener('DOMContentLoaded', loadCountriesAndPhoneCodes);


        // Load Departments

        async function loadDepartments() {
        const response = await fetch('/hrms/api/department/');
        const departments = await response.json();
        const departmentSelect = document.getElementById('internal_organization');

        departments.forEach(department => {
            const option = document.createElement('option');
            option.value = department.id;  // Store department ID as the value
            option.textContent = `${department.name} (Company: ${department.company_name})`;
            departmentSelect.appendChild(option);
        });
    }

    document.addEventListener('DOMContentLoaded', loadDepartments);

    // Checking validations fo employee Id and email to prevent duplicate entries
    async function checkIfExists(url, value) {
        const response = await fetch(`${url}?${url.includes('email') ? 'email' : 'employee_id'}=${value}`);
        const data = await response.json();
        return data.exists;
    }

    document.querySelector('form').addEventListener('submit', async function(event) {
        event.preventDefault();  // Prevent form submission until validation is done

        const email = document.getElementById('email').value;
        const employeeId = document.getElementById('employee_id').value;

        // Check if email already exists
        const emailExists = await checkIfExists('/hrms/check-email/', email);
        if (emailExists) {
            alert('Email already exists. Please use a different email address.');
            document.getElementById('email').focus();
            return;  // Stop form submission
        }

        // Check if employee ID already exists
        const idExists = await checkIfExists('/hrms/check-employee-id/', employeeId);
        if (idExists) {
            alert('Employee ID already exists. Please use a different employee ID.');
            document.getElementById('employee_id').focus();
            return;  // Stop form submission
        }

        // If validation passes, submit the form
        this.submit();
    });

    </script>
</body>

</html>
{% endblock %}