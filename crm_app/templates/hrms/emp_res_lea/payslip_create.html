{% extends "dash_navbar.html" %}

{% load static %}
<!DOCTYPE html>
<html lang="en">
    {% block content %}
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payslip Generator</title>
<link rel="stylesheet" href="style.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<style>
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
}

.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    position: relative;
    width: 90%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    position: relative;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.l-corner {
    flex-grow: 1;
    margin-top: 20px;
}

.right-corner {
    position: relative;
    text-align: right;
    padding: 5px 10px; /* Reduced padding for less space */
    font-size: 14px;
    line-height: 1.4; /* Reduced line height for tighter spacing */
    margin-left: auto; /* Ensures it aligns to the right in the header */
}

/* For mobile responsiveness */
@media (max-width: 768px) {
    .right-corner {
        position: static; /* Resets absolute positioning */
        text-align: left; /* Aligns the text to the left on mobile */
        margin-top: 10px; /* Reduced top margin for more compact view */
        padding-left: 0;
        padding-right: 0; /* No extra padding on mobile */
    }
}

/* Table styling */
table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
}

th, td {
    padding: 12px 15px;
    text-align: left;
    border: 1px solid #ddd;
    font-size: 16px; /* Ensures readability */
}

th {
    background-color: #f4f4f4; /* Light gray background for headers */
    font-weight: bold;
}

td input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}

td input:focus {
    border-color: #0073e6; /* Focus effect for better UX */
}

td {
    vertical-align: middle; /* Ensures vertical alignment for inputs */
}

/* Table Section Headers */
table tr th[colspan="4"] {
    background-color: #0073e6; /* Navbar color for table sections */
    color: white;
    text-align: center;
    font-size: 18px;
}

/* Input group styling */
.input-group {
    display: flex;
    align-items: center;
    width: 100%;
}

.input-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
}

.input-group button {
    padding: 8px;
    background-color: #bcd0e4;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}

.input-group button:hover {
    background-color: #005bb5;
}

/* Calendar section styling */
.calendar-section {
    margin: 20px 0;
    text-align: center;
}

.calendar-section label {
    font-weight: bold;
    margin-right: 10px;
}

.calendar-section input[type="date"] {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

/* Button Styling */
button {
    width: 20%;
    padding: 10px;
    background-color: #0073e6;
    color: #fff;
    border: none;
    margin: 10px auto;
    text-align: center;
    cursor: pointer;
    border-radius: 4px;
}

button:hover {
    background-color: #005bb5;
}

.button-container {
    text-align: center;
    margin-top: 10px;
}

/* Left and right corners */
.container .header {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
}

.container .left-corner,
.container .right-corner {
    font-size: 14px;
}



/* Make the form more fluid on smaller devices */
@media (max-width: 768px) {
    .container {
        width: 95%;
        padding: 15px;
    }

    .right-corner {
        position: static;
        text-align: left;
        margin-top: 20px;
    }

    .header {
        flex-direction: column;
    }

    .input-group {
        flex-direction: column;
        align-items: stretch;
    }

    .input-group button {
        margin-top: 10px;
    }

    button {
        width: 100%; /* Make buttons full-width on smaller screens */
    }

    table {
        font-size: 14px; /* Adjust font size for smaller devices */
    }
}

.account-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.account-grid div {
    display: flex;
    align-items: center;
}

@media (max-width: 480px) {
    table th, table td {
        padding: 8px; /* Adjust padding for smaller screens */
    }

    .input-group input, .input-group button {
        font-size: 14px;
    }

    button {
        width: 100%;
        padding: 12px;
    }
}


/* Make the form more fluid on smaller devices */
@media (max-width: 768px) {
    .container {
        width: 95%; /* Make the container width even more responsive */
        padding: 15px;
    }

    .right-corner {
        position: static;
        text-align: left;
        margin-top: 20px;
    }

    .header {
        flex-direction: column;
    }

    .input-group {
        flex-direction: column;
        align-items: stretch;
    }

    .input-group button {
        margin-top: 10px;
    }

    button {
        width: 100%; /* Make buttons full-width on smaller screens */
    }

    table {
        font-size: 14px; /* Adjust font size for smaller devices */
    }
    .right-corner {
        position: static; /* Reset position to flow with the document */
        text-align: left; /* Align text to the left */
        margin-top: 20px; /* Add spacing for clarity */
    }

    .header {
        flex-direction: column; /* Stack header content vertically */
    }

}
.account-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px; /* Adjust spacing between grid items */
}

.account-grid div {
    display: flex;
    align-items: center;
}

@media (max-width: 480px) {
    table th, table td {
        padding: 4px; /* Reduce padding on smaller screens */
    }

    .input-group input, .input-group button {
        font-size: 14px;
    }

    button {
        width: 100%;
        padding: 12px;
    }
}


</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>


</head>
<body>
    <div class="container">
        <div class="header">
            <!-- Center aligned heading section -->
            <div class="l-corner">
                <h2>Aapai Technologies</h2>
                <h3>Payslip for the Month</h3>
            </div>
            <!-- Right aligned contact details section -->
            <div class="right-corner">
                <p>GST Number: <span id="gstNumber">XXXXXXX</span></p>
                <p><a href="mailto:example@email.com">Email: example@email.com</a></p>
                <p>Website: <a href="https://www.example.com" target="_blank">www.example.com</a></p>
                <p>Address: 1234 Main St, City, State</p>
                <p>Contact: +123 456 7890</p>
            </div>
        </div>

        <!-- Rest of your content here -->
   
        <!-- Table content goes here -->

    

    <table>
        <tr>
            <th colspan="4" style="text-align: center;">Basic Information</th>
        </tr>
        <tr>
            <th>Employee Details</th>
          <td colspan="3">
            <div class="account-grid">
                <div class="input-group">
                    <input type="text" id="employeeId" class="form-control" placeholder="Employee ID">
                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#appIDModal">
                        <i class="bi bi-search"></i> <!-- Bootstrap Icons search icon -->
                    </button>
                </div>
                <div><input type="text" id="employeeName"   placeholder="Employee Name" class="form-control"></div>
                <div><input type="text" id="employeeDep"   placeholder="Employee Department" class="form-control"></div>
                <div><input type="text"  id="designation"   placeholder="Designation" class="form-control"></div>
                <div><input type="text"   id="Contactnumber"   placeholder="Contact No." class="form-control"></div>

            </div>
        </td>
    </tr>
           
        <tr>
            <th>Pay Slip Period</th>
            <td colspan="1">
                <div class="input-group">
                    <input type="date" id="startDate" class="form-control" placeholder="Start Date" style="margin-right: 10px;">
                    <span class="input-group-text"> - </span>
                    <input type="date" id="endDate" class="form-control" placeholder="End Date" style="margin-left: 10px;">
                </div>
            </td> 
            <th>Date of Issue</th>
            <td>
                <input type="date" id="deductionDate" class="form-control">
            </td>
        </tr>
        
        <tr>
            <th>Account Details</th>
            <td colspan="3">
                <div class="account-grid">
                    <div><input type="text" id="bankName" placeholder="Bank Name" class="form-control"></div>
                    <div><input type="text" id="accountNo" placeholder="Account Number" class="form-control"></div>
                    <div><input type="text" id="ifscCode" placeholder="IFSC Code" class="form-control"></div>
                    <div><input type="text" id="pfnumber" placeholder="PF A/C No" class="form-control"></div>
                    <div><input type="text" id="Unanumber" placeholder="UAN No" class="form-control"></div>
                    <div><input type="text" id="Pannumber" placeholder="PAN No." class="form-control"></div>
                </div>
            </td>
        </tr>
        <tr>
            <th colspan="4" style="text-align:center;">Earnings</th>
        </tr>
        <tr>
            <th>Basic Salary</th>
            <td><input type="number" id="basicSalary" value="0"></td>
            <th>House Rent Allowance</th>
            <td><input type="number" id="houseRent" value="0"></td>
        </tr>
        <tr>
            <th>Conveyance Allowance</th>
            <td><input type="number" id="conveyance" value="0"></td>
            <th>Flat Allowance</th>
            <td><input type="number" id="flatAllowance" value="0"></td>
        </tr>
        <tr>
            <th>Skill Bonus</th>
            <td><input type="number" id="skillBonus" value="0"></td>
            <th>Special Payment</th>
            <td><input type="number" id="specialPayment" value="0"></td>
            
        </tr>
        <tr>
            <th>Unpaid Leaves</th>
            <td colspan="3">
                <div class="account-grid" style="display: flex; align-items: center; gap: 50px;">
                    <input type="number" id="unpaidLeaves1" value="0" class="form-control" style="width: 50%;">
                    <input type="number" id="unpaidLeaves2" value="0" class="form-control" style="width: 50%;">
                </div>
            </td>
        </tr>
        <tr>
            <th>Total Earnings</th>
            <td colspan="3"><span id="totalEarnings">0</span></td>
        </tr>
        <tr>
            <th colspan="4" style="text-align:center;">Deductions</th>
        </tr>
        <tr>
            <th>ESI Contribution</th>
            <td><input type="number" id="esiContribution" value="0"></td>
            <th>PF Contribution</th>
            <td><input type="number" id="pfContribution" value="0"></td>
        </tr>
        <tr>
            <th>Professional Tax</th>
            <td><input type="number" id="professionalTax" value="0"></td>
            <th>Total Deductions</th>
            <td><span id="totalDeductions">0</span></td>
            
         
        </tr>
        <tr>
            <th>Net Salary</th>
            <td colspan="3"><span id="netSalary" class="form-control">0</span></td>
       
        </tr>

    </table>

    <div class="button-container">
        <button onclick="calculatePayslip()">Calculate Payslip</button>
        <button onclick="generatePDF()">Download Payslip</button>
        <button onclick="savePayslip()">Save Payslip</button>
    </div>
</div>



<script>
    
    function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const leftMargin = 15;
    const topMargin = 20;
    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;

    // Title Section
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.text("Aapai Technologies", leftMargin, topMargin);
    doc.setFontSize(10);
    doc.text("Payslip for the Month", leftMargin, topMargin + 10);

    // Company Details
    const rightColumnX = pageWidth - 120;
    doc.setFontSize(8);
    doc.text("GST Number: XXXXXX", rightColumnX + 60, topMargin);
    doc.text("Email: example@email.com", rightColumnX + 60, topMargin + 5);
    doc.text("Website: www.example.com", rightColumnX + 60, topMargin + 10);
    doc.text("Address: 1234 Main St, City, State", rightColumnX + 60, topMargin + 15);
    doc.text("Contact: +123 456 7890", rightColumnX + 60, topMargin + 20);

    doc.line(leftMargin, topMargin + 25, pageWidth - leftMargin, topMargin + 25);

    // Payslip Period and Date
    const payslipPeriod = `${document.getElementById('startDate').value} - ${document.getElementById('endDate').value}`;
    const dateOfIssue = document.getElementById('deductionDate').value;
    doc.setFontSize(8);
    doc.text("Payslip Period: " + payslipPeriod, leftMargin, topMargin + 30);
    doc.text("Date of Issue: " + dateOfIssue, leftMargin, topMargin + 35);

    doc.line(leftMargin, topMargin + 40, pageWidth - leftMargin, topMargin + 40);

    let currentY = topMargin + 45;

    // Basic Information Table
    const basicInfo = [
        ["Employee ID", document.getElementById('employeeId').value],
        ["Employee Name", document.getElementById('employeeName').value],
        ["Employee Department", document.getElementById('employeeDep').value],
        ["Designation", document.getElementById('designation').value],
        ["Contact No.", document.getElementById('Contactnumber').value],
        ["Bank Name", document.getElementById('bankName').value],
        ["Account Number", document.getElementById('accountNo').value],
        ["IFSC Code", document.getElementById('ifscCode').value],
        ["PF A/C No.", document.getElementById('pfnumber').value],
        ["UAN No.", document.getElementById('Unanumber').value],
        ["PAN No.", document.getElementById('Pannumber').value]
    ];

    doc.autoTable({
        head: [["Basic Information", "Value"]],
        body: basicInfo.map(item => [item[0], item[1]]),
        startY: currentY,
        theme: 'grid',
        styles: { cellPadding: 2, fontSize: 8 },
        margin: { top: 0, bottom: 0 }
    });

    currentY = doc.lastAutoTable.finalY + 5;

    // Earnings Table
    const earnings = [
        ["Basic Salary", document.getElementById('basicSalary').value],
        ["House Rent Allowance", document.getElementById('houseRent').value],
        ["Conveyance Allowance", document.getElementById('conveyance').value],
        ["Flat Allowance", document.getElementById('flatAllowance').value],
        ["Skill Bonus", document.getElementById('skillBonus').value],
        ["Special Payment", document.getElementById('specialPayment').value],
        ["Unpaid Leaves", document.getElementById('unpaidLeaves1').value + " / " + document.getElementById('unpaidLeaves2').value],
        ["Total Earnings", document.getElementById('totalEarnings').innerText]
    ];

    doc.autoTable({
        head: [["Earnings", "Amount"]],
        body: earnings.map(item => [item[0], item[1]]),
        startY: currentY,
        theme: 'grid',
        styles: { cellPadding: 2, fontSize: 8 },
        columnStyles: {
            1: { halign: 'right', cellWidth: 'auto' } // Align amounts to the right with automatic width
        },
        margin: { top: 0, bottom: 0 }
    });

    currentY = doc.lastAutoTable.finalY + 5;

    // Deductions Table
    const deductions = [
        ["ESI Contribution", document.getElementById('esiContribution').value],
        ["PF Contribution", document.getElementById('pfContribution').value],
        ["Professional Tax", document.getElementById('professionalTax').value],
        ["Total Deductions", document.getElementById('totalDeductions').innerText]
    ];

    doc.autoTable({
        head: [["Deductions", "Amount"]],
        body: deductions.map(item => [item[0], item[1]]),
        startY: currentY,
        theme: 'grid',
        styles: { cellPadding: 2, fontSize: 8 },
        columnStyles: {
            1: { halign: 'right', cellWidth: 'auto' } // Align amounts to the right with automatic width
        },
        margin: { top: 0, bottom: 0 }
    });

    currentY = doc.lastAutoTable.finalY + 5;

    // Net Salary Table
    const netSalary = document.getElementById('netSalary').innerText;
    const netSalaryTable = [
        ["Net Salary", netSalary]
    ];

    doc.autoTable({
        head: [["Total", "Amount"]],
        body: netSalaryTable,
        startY: currentY,
        theme: 'grid',  // Using the 'grid' theme for consistency
        styles: {
            cellPadding: 2,  // Reduced padding for consistency with other tables
            fontSize: 8,      // Same font size as the rest of the content
            fontStyle: "bold",
            textColor: [0, 0, 0]  // Black text color
        },
        columnStyles: {
            1: { halign: 'right', cellWidth: 'auto' } // Align the amount in the second column (index 1) to the right
        },
        margin: { top: 0, bottom: 0 }
    });

    doc.save("Aapai_Technologies_Payslip.pdf");
}





function savePayslip() {
    // Helper function to retrieve form values safely
    const getFieldValue = (id, isText = false) => {
        const element = document.getElementById(id);
        if (element) {
            return isText ? element.innerText.trim() : element.value.trim();
        }
        return "";
    };

    // Collect all necessary fields
    const payslipData = {
        employeeId: getFieldValue("employeeId"),
        employeeName: getFieldValue("employeeName"),
        employeeDepartment: getFieldValue("employeeDep"),
        bankDetails: getFieldValue("bankName"),
        accountNo: getFieldValue("accountNo"),
        basicSalary: getFieldValue("basicSalary"),
        conveyanceAllowance: getFieldValue("conveyance"),
        skillBonus: getFieldValue("skillBonus"),
        houseRentAllowance: getFieldValue("houseRent"),
        flatAllowance: getFieldValue("flatAllowance"),
        specialPayment: getFieldValue("specialPayment"),
        esiContribution: getFieldValue("esiContribution"),
        professionalTax: getFieldValue("professionalTax"),
        pfContribution: getFieldValue("pfContribution"),
        totalEarnings: getFieldValue("totalEarnings", true) || "0",
        totalDeductions: getFieldValue("totalDeductions", true) || "0",
        takeHomePay: getFieldValue("takeHomePay", true) || "0",
        unpaidLeaves: `${getFieldValue("unpaidLeaves1")} / ${getFieldValue("unpaidLeaves2")}`,
        date: getFieldValue("deductionDate")
    };

    // Validate required fields
    const requiredFields = [
        { name: "Employee ID", value: payslipData.employeeId },
        { name: "Employee Name", value: payslipData.employeeName },
        { name: "Employee Department", value: payslipData.employeeDepartment },
        { name: "Bank Name", value: payslipData.bankDetails },
        { name: "Account Number", value: payslipData.accountNo },
        { name: "Date", value: payslipData.date }
    ];

    const missingFields = requiredFields.filter(field => !field.value);
    if (missingFields.length > 0) {
        const missingFieldNames = missingFields.map(field => field.name).join(", ");
        alert(`Please fill in the following required fields: ${missingFieldNames}`);
        return;
    }

    // Save data to localStorage
    try {
        localStorage.setItem("payslipData", JSON.stringify(payslipData));
        alert("Payslip saved successfully!");

        // Redirect to the Payslip page
        window.location.href = "employee_payslips.html"; // Update this to your correct path
    } catch (error) {
        console.error("Failed to save payslip:", error);
        alert("An error occurred while saving the payslip. Please try again.");
    }
}



</script>
</body>
</html>
{% endblock %}