{% extends "dash_navbar.html" %}
{% load static %}
<!DOCTYPE html>
<html lang="en">

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container my-5">
        <!-- Page Title Section -->
        <div class="text-center mb-7">
            <h1>Find Interview Details</h1>
        </div>

        <!-- Button Bar -->
        <div class="text-end mb-4">
            <a class="btn btn-primary" href="{% url 'NewjobInterview' %}">New Job Interview</a>
        </div>

        <!-- Search Options -->
        <div id="searchOptions" class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title m-0">Search Options</h3>
                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#searchOptions_col"
                    aria-expanded="true" aria-controls="searchOptions_col">
                    Collapse
                </button>
            </div>
            <div id="searchOptions_col" class="collapse show">
                <div class="card-body">
                    <form id="FindJobInterview" class="row g-3">
                        <!-- Job Interview ID -->
                        <div class="col-md-6">
                            <label for="jobInterviewId" class="form-label">Job Interview ID</label>
                            <div class="input-group">
                                <select name="jobInterviewId_op" id="jobInterviewId_op" class="form-select">
                                    <option value="equals" selected>Equals</option>
                                    <option value="lessThan">Less Than</option>
                                    <option value="greaterThan">Greater Than</option>
                                </select>
                                <input type="text" name="jobInterviewId" id="jobInterviewId" class="form-control"
                                    maxlength="20">
                            </div>
                        </div>

                        <!-- Job Interviewee Party ID -->
                        <div class="col-md-6">
                            <label for="jobIntervieweePartyId" class="form-label">Job Interviewee Party ID</label>
                            <div class="input-group">
                                <input type="text" name="jobIntervieweePartyId" id="jobIntervieweePartyId"
                                    class="form-control">
                                <button class="btn btn-outline-secondary" type="button"
                                    id="show-modal-btn3">Lookup</button>
                            </div>
                        </div>

                        <!-- Modal for Lookup -->
                        <div id="myModal3" class="modal">
                            <div class="modal-content">
                                <span class="close" id="close-modal-btn3">&times;</span>
                                <iframe src="{% url 'lookup' %}" style="width: 100%; height: 600px"
                                    frameborder="0"></iframe>
                            </div>
                        </div>


                        <!-- Job Requisition ID -->
                        <div class="col-md-6">
                            <label for="jobRequisitionId" class="form-label">Job Requisition ID</label>
                            <div class="input-group">
                                <input type="text" name="jobRequisitionId" id="jobRequisitionId" class="form-control">
                                <button class="btn btn-outline-secondary" type="submit"
                                    id="1_lookupId_button">Lookup</button>
                            </div>
                        </div>

                        <!-- Job Interviewer Party ID -->
                        <div class="col-md-6">
                            <label for="jobInterviewerPartyId" class="form-label">Job Interviewer Party ID</label>
                            <div class="input-group">
                                <input type="text" name="jobInterviewerPartyId" id="jobInterviewerPartyId"
                                    class="form-control">
                                <button class="btn btn-outline-secondary" type="submit"
                                    id="show-modal-btn">Lookup</button>
                            </div>
                        </div>

                        <div id="myModal" class="modal">
                            <div class="modal-content">
                                <span class="close" id="close-modal-btn">&times;</span>
                                <iframe src="{% url 'lookup' %}" style="width: 100%; height: 600px"
                                    frameborder="0"></iframe>
                            </div>
                        </div>

                        <!-- Job Interview Type -->
                        <div class="col-md-6">
                            <label for="jobInterviewTypeId" class="form-label">Job Interview Type</label>
                            <select name="jobInterviewTypeId" id="jobInterviewTypeId" class="form-select">
                                <option value="">Select Interview Type</option>
                            </select>
                        </div>

                        <!-- Grade Secured -->
                        <div class="col-md-6">
                            <label for="gradeSecuredEnumId" class="form-label">Grade Secured</label>
                            <select name="gradeSecuredEnumId" id="gradeSecuredEnumId" class="form-select">
                                <option value="">&nbsp;</option>
                                <option value="INTR_RATNG_A">A (above 75%)</option>
                                <option value="INTR_RATNG_B">B (60-75%)</option>
                                <option value="INTR_RATNG_C">C (45-60%)</option>
                                <option value="INTR_RATNG_D">D (below 40%)</option>
                            </select>
                        </div>

                        <!-- Interview Result -->
                        <div class="col-md-6">
                            <label for="jobInterviewResult" class="form-label">Job Interview Result</label>
                            <select name="jobInterviewResult" id="jobInterviewResult" class="form-select">
                                <option value="">&nbsp;</option>
                                <option value="Pass">Pass</option>
                                <option value="Fail">Fail</option>
                            </select>
                        </div>

                        <!-- Interview Date -->
                        <div class="col-md-6">
                            <label for="jobInterviewStartDate" class="form-label">Job Interview Date</label>
                            <div class="input-group">
                                <input type="date" class="form-control" name="jobInterviewStartDate"
                                    id="jobInterviewStartDate" placeholder="YYYY-MM-DD">
                                <select name="jobInterviewStartDate_op" id="jobInterviewStartDate_op"
                                    class="form-select">
                                    <option value="equals">Equals</option>
                                    <option value="greaterThan" selected>Greater Than</option>
                                </select>
                                <input type="date" class="form-control" name="jobInterviewEndDate"
                                    id="jobInterviewEndDate" placeholder="YYYY-MM-DD">
                                <select name="jobInterviewEndDate_op" id="jobInterviewEndDate_op" class="form-select">
                                    <option value="equals">Equals</option>
                                    <option value="lessThan" selected>Less Than</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Find</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="mt-4">
            <h3>Search Results</h3>
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th>Job Interview ID</th>
                        <th>Job Interviewee Party ID</th>
                        <th>Job Requisition ID</th>
                        <th>Job Interviewer Party ID</th>
                        <th>Job Interview Type ID</th>
                        <th>Grade Secured</th>
                        <th>Job Interview Result</th>
                        <th>Job Interview Date</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <!-- Dynamic results go here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
            async function loadDropdowns() {

                // Load Leave Types
                const jobInterviewTypeResponse = await fetch('/hrms/api/jobinterviewtypes/');
                const jobInterviewTypes = await jobInterviewTypeResponse.json();
                const jobInterviewTypeSelect = document.getElementById('jobInterviewTypeId');

                jobInterviewTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.jobinterviewType;
                    option.textContent = type.description;
                    jobInterviewTypeSelect.appendChild(option);
                });
            }

            document.addEventListener('DOMContentLoaded', loadDropdowns);
    </script>


    <script>
            ///////////////////////////////////// Lookup Models //////////////////////////////////


            let targetField = null; // Declare targetField globally

            function selectEmployeeId(employeeId) {
                console.log(`Selected Employee ID: ${employeeId} for ${targetField}`);
                if (targetField) {
                    // Fill the selected field with the employee ID
                    document.getElementById(targetField).value = employeeId;
                }

                // Close the appropriate modal
                if (targetField === 'jobIntervieweePartyId') {
                    document.getElementById("myModal3").style.display = "none";
                } else if (targetField === 'jobInterviewerPartyId') {
                    document.getElementById("myModal").style.display = "none";
                }

                // Reset targetField after use
                targetField = null;
            }

            // Event listener for opening the Interviewee Party ID modal
            document.getElementById("show-modal-btn3").addEventListener("click", function (event) {
                event.preventDefault(); // Prevent default form submission
                targetField = 'jobIntervieweePartyId';
                document.getElementById("myModal3").style.display = "block";
            });

            // Close modal functionality
            document.getElementById("close-modal-btn3").addEventListener("click", function () {
                document.getElementById("myModal3").style.display = "none";
            });

            // Close modal when clicking outside of it
            window.onclick = function (event) {
                const modal = document.getElementById("myModal3");
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };




            // Show modal for Appplying Party ID
            document.getElementById("show-modal-btn").addEventListener("click", function (event) {
                event.preventDefault(); // Prevent default form submission
                targetField = 'jobInterviewerPartyId';
                document.getElementById("myModal").style.display = "block";
            });

            // Close modal functionality
            document.getElementById("close-modal-btn").addEventListener("click", function () {
                document.getElementById("myModal").style.display = "none";
            });

            // Close modal when clicking outside of it
            window.onclick = function (event) {
                const modal = document.getElementById("myModal");
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            };

    </script>

<script>
    function populateResultsTable(data) {
        console.log('Data received:', data); // Log the data to check its contents
        const tbody = document.querySelector('#resultsBody');
        tbody.innerHTML = ''; // Clear existing results

        if (data.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="8">No results found.</td>';
            tbody.appendChild(emptyRow);
        } else {
            data.forEach((interview) => {
                const row = document.createElement('tr');
                const formattedJobInterviewDate = interview.jobInterviewDate
                    ? new Date(interview.jobInterviewDate).toLocaleDateString()
                    : 'N/A';

                row.innerHTML = `
                    <td>${interview.jobInterviewId || 'N/A'}</td>
                    <td>${interview.jobIntervieweePartyId || 'N/A'}</td>
                    <td>${interview.jobRequisitionId || 'N/A'}</td>
                    <td>${interview.jobInterviewerPartyId || 'N/A'}</td>
                    <td>${interview.jobInterviewTypeId || 'N/A'}</td>
                    <td>${interview.gradeSecuredEnumId || 'N/A'}</td>
                    <td>${interview.jobInterviewResult || 'Not Available'}</td>
                    <td>${formattedJobInterviewDate}</td>
                `;
                tbody.appendChild(row);
            });
        }
    }

    document.getElementById('FindJobInterview').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent default form submission

        // Collect form data
        const jobInterviewId = document.getElementById('jobInterviewId').value.trim();
        const jobInterviewIdOp = document.getElementById('jobInterviewId_op').value;

        const jobIntervieweePartyId = document.getElementById('jobIntervieweePartyId').value.trim();
        const jobRequisitionId = document.getElementById('jobRequisitionId').value.trim();
        const jobInterviewerPartyId = document.getElementById('jobInterviewerPartyId').value.trim();

        const jobInterviewTypeId = document.getElementById('jobInterviewTypeId').value;
        const gradeSecuredEnumId = document.getElementById('gradeSecuredEnumId').value;
        const jobInterviewResult = document.getElementById('jobInterviewResult').value;

        const jobInterviewStartDate = document.getElementById('jobInterviewStartDate').value;
        const jobInterviewStartDateOp = document.getElementById('jobInterviewStartDate_op').value;
        const jobInterviewEndDate = document.getElementById('jobInterviewEndDate').value;
        const jobInterviewEndDateOp = document.getElementById('jobInterviewEndDate_op').value;

        // Create a payload object
        const payload = {
            job_interview_id: jobInterviewId || null,
            job_interview_id_op: jobInterviewIdOp || 'contains',
            job_interviewee_party_id: jobIntervieweePartyId || null,
            job_requisition_id: jobRequisitionId || null,
            job_interviewer_party_id: jobInterviewerPartyId || null,
            job_interview_type_id: jobInterviewTypeId || null,
            grade_secured_enum_id: gradeSecuredEnumId || null,
            job_interview_result: jobInterviewResult || null,
            job_interview_start_date: jobInterviewStartDate || null,
            job_interview_start_date_op: jobInterviewStartDateOp || 'greaterThan',
            job_interview_end_date: jobInterviewEndDate || null,
            job_interview_end_date_op: jobInterviewEndDateOp || 'lessThan',
        };
        console.log('Payload sent to server:', payload);

        // Make the AJAX request
        fetch('/hrms/job-interview-search/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload),
        })
        .then(response => {
            console.log('Raw response:', response);  // Log the raw response to check if it's valid
            return response.json();
        })
        .then(data => {
            console.log('Data received:', data);
            populateResultsTable(data);
        })
        .catch(error => console.error('Error fetching interview data:', error));

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
{% endblock %}